<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi ti·∫øt Kh√°ch h√†ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
  </head>
  <body class="bg-gray-100">
    <div class="flex h-screen overflow-hidden">
      <aside class="sidebar fixed inset-y-0 left-0 z-30 w-64 bg-gray-900 text-white flex-shrink-0 md:relative md:transform-none flex flex-col" id="sidebar">
        <div class="flex items-center justify-center h-20 border-b border-gray-700">
          <i class="fas fa-route text-3xl text-blue-400"></i>
          <span class="ml-3 text-2xl font-bold">TravelGO</span>
        </div>
        <nav class="mt-8 px-4">
          <a th:href="@{/nhanvien/dashboard}" class="flex items-center px-4 py-3 rounded-lg" th:classappend="${#httpServletRequest != null and #httpServletRequest.requestURI.matches('^/nhanvien/dashboard.*') ? ' bg-gray-700 text-white shadow-md' : ' text-gray-300 hover:bg-gray-700'}">
            <i class="fas fa-tachometer-alt w-6 text-center"></i><span class="ml-4">Dashboard</span>
          </a>
          <a th:href="@{/nhanvien/bookings}" class="flex items-center px-4 py-3 mt-4 rounded-lg" th:classappend="${#httpServletRequest != null and #httpServletRequest.requestURI.matches('^/nhanvien/bookings.*') ? ' bg-gray-700 text-white shadow-md' : ' text-gray-300 hover:bg-gray-700'}">
            <i class="fas fa-book-open w-6 text-center"></i><span class="ml-4">Qu·∫£n l√Ω ƒê·∫∑t ch·ªó</span>
          </a>
          <a th:href="@{/nhanvien/customers}" class="flex items-center px-4 py-3 mt-4 rounded-lg" th:classappend="${#httpServletRequest != null and #httpServletRequest.requestURI.matches('^/nhanvien/customers.*') ? ' bg-gray-700 text-white shadow-md' : ' text-gray-300 hover:bg-gray-700'}">
            <i class="fas fa-users w-6 text-center"></i><span class="ml-4">Qu·∫£n l√Ω Kh√°ch h√†ng</span>
          </a>
          <a th:href="@{/nhanvien/manager_tour}" class="flex items-center px-4 py-3 mt-4 rounded-lg" th:classappend="${#httpServletRequest != null and #httpServletRequest.requestURI.matches('^/nhanvien/manager_tour.*') ? ' bg-gray-700 text-white shadow-md' : ' text-gray-300 hover:bg-gray-700'}">
            <i class="fas fa-map-marked-alt w-6 text-center"></i><span class="ml-4">Qu·∫£n l√Ω Tour</span>
          </a>
          <a th:href="@{/nhanvien/finance}" class="flex items-center px-4 py-3 mt-4 text-gray-300 hover:bg-gray-700 rounded-lg">
              <i class="fas fa-file-invoice-dollar w-6 text-center"></i><span class="ml-4">Thu/Chi chuy·∫øn</span>
          </a>           
          <a th:href="@{/nhanvien/report}" class="flex items-center px-4 py-3 mt-4 rounded-lg" th:classappend="${#httpServletRequest != null and #httpServletRequest.requestURI.matches('^/nhanvien/report.*') ? ' bg-gray-700 text-white shadow-md' : ' text-gray-300 hover:bg-gray-700'}">
            <i class="fas fa-chart-pie w-6 text-center"></i><span class="ml-4">Xu·∫•t b√°o c√°o</span>
          </a>
        </nav>
        <div class="mt-auto w-full p-4 border-t border-gray-800">
          <a th:href="@{/logout}" class="flex items-center px-4 py-3 text-gray-300 hover:bg-gray-700 rounded-lg">
            <i class="fas fa-sign-out-alt w-6 text-center"></i>
            <span class="ml-4">ƒêƒÉng xu·∫•t</span>
          </a>
        </div>
      </aside>

      <div class="flex-1 flex flex-col overflow-y-auto">
        <header
          class="flex items-center justify-between p-6 bg-white border-b border-gray-200"
        >
          <div>
            <a
              th:href="@{/nhanvien/customers}"
              class="text-blue-600 hover:underline"
              ><i class="fas fa-arrow-left mr-2"></i>Quay l·∫°i danh s√°ch</a
            >
            <h1
              id="customer-header"
              class="text-2xl font-semibold text-gray-800 mt-2"
            >
              Chi ti·∫øt Kh√°ch h√†ng
            </h1>
          </div>
          <a
            href="#"
            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg"
          >
            <i class="fas fa-edit mr-2"></i>S·ª≠a th√¥ng tin
          </a>
        </header>

        <main class="flex-1 p-6">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1">
              <div class="bg-white p-6 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold border-b pb-2 mb-4">
                  Th√¥ng tin c√° nh√¢n
                </h3>
                <div class="space-y-3 text-sm">
                  <p><strong>H·ªç t√™n:</strong> <span id="hoTen"></span></p>
                  <p><strong>Email:</strong> <span id="email"></span></p>
                  <p><strong>SƒêT:</strong> <span id="soDienThoai"></span></p>
                  <p><strong>ƒê·ªãa ch·ªâ:</strong> <span id="diaChi"></span></p>
                  <p><strong>Ng√†y sinh:</strong> <span id="ngaySinh"></span></p>
                  <p><strong>Gi·ªõi t√≠nh:</strong> <span id="gioiTinh"></span></p>
                  <p>
                    <strong>Ng√†y tham gia:</strong>
                    <span id="ngayThamGia"></span>
                  </p>
                </div>
              </div>
            </div>

            <div class="lg:col-span-2">
              <div class="bg-white p-6 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold border-b pb-2 mb-4">
                  L·ªãch s·ª≠ ƒë·∫∑t ch·ªó
                </h3>
                <div class="overflow-x-auto">
                  <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                      <tr>
                        <th scope="col" class="px-6 py-3">M√£ ƒê∆°n</th>
                        <th scope="col" class="px-6 py-3">T√™n Tour</th>
                        <th scope="col" class="px-6 py-3">Ng√†y ƒê·∫∑t</th>
                        <th scope="col" class="px-6 py-3">Tr·∫°ng th√°i</th>
                      </tr>
                    </thead>
                    <tbody id="booking-history-body"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
<input type="hidden" id="customerId" th:value="${customerId ?: 0}" />
 <script th:inline="javascript">
  // ‚úÖ N·∫øu customerId kh√¥ng t·ªìn t·∫°i trong model, g√°n m·∫∑c ƒë·ªãnh l√† 0 ƒë·ªÉ tr√°nh l·ªói c√∫ ph√°p
const customerId = parseInt(document.getElementById("customerId").value);



  function getStatusBadge(status) {
    const base = "px-2 py-1 text-xs font-semibold rounded-full";
    if (status === "ƒê√£ thanh to√°n")
      return `<span class="${base} bg-green-100 text-green-800">${status}</span>`;
    if (status === "ƒê√£ h·ªßy")
      return `<span class="${base} bg-red-100 text-red-800">${status}</span>`;
    if (status === "ƒê√£ x√°c nh·∫≠n")
      return `<span class="${base} bg-blue-100 text-blue-800">${status}</span>`;
    return `<span class="${base} bg-yellow-100 text-yellow-800">${status}</span>`;
  }

  async function loadCustomerDetails() {
    if (!customerId || customerId === 0) {
      console.error("‚ùå customerId kh√¥ng h·ª£p l·ªá!");
      return;
    }

    try {
      const response = await fetch(`/nhanvien/customers/api/${customerId}`);
      if (!response.ok) throw new Error(`API l·ªói: ${response.status}`);
      const data = await response.json();

      const customer = data.customer;
      const bookingHistory = data.bookingHistory || [];

      // ü™™ Th√¥ng tin c√° nh√¢n
      document.getElementById("customer-header").textContent = `Chi ti·∫øt: ${customer.taiKhoan.hoTen}`;
      document.getElementById("hoTen").textContent = customer.taiKhoan.hoTen;
      document.getElementById("email").textContent = customer.taiKhoan.email;
      document.getElementById("soDienThoai").textContent = customer.taiKhoan.soDienThoai;
      document.getElementById("diaChi").textContent = customer.diaChi || "Ch∆∞a c·∫≠p nh·∫≠t";
      document.getElementById("ngaySinh").textContent = customer.ngaySinh
        ? new Date(customer.ngaySinh).toLocaleDateString("vi-VN")
        : "Ch∆∞a c·∫≠p nh·∫≠t";
      document.getElementById("gioiTinh").textContent = customer.gioiTinh || "Ch∆∞a c·∫≠p nh·∫≠t";
      document.getElementById("ngayThamGia").textContent = customer.ngayThamGia
        ? new Date(customer.ngayThamGia).toLocaleDateString("vi-VN")
        : "Ch∆∞a c·∫≠p nh·∫≠t";

      // üìú L·ªãch s·ª≠ ƒë·∫∑t ch·ªó
      const historyBody = document.getElementById("booking-history-body");
      historyBody.innerHTML = "";

      if (bookingHistory.length === 0) {
        historyBody.innerHTML =
          `<tr><td colspan="4" class="text-center py-4 text-gray-500">
            Kh√°ch h√†ng n√†y ch∆∞a ƒë·∫∑t tour n√†o.
          </td></tr>`;
      } else {
        bookingHistory.forEach((booking) => {
          historyBody.innerHTML += `
            <tr class="bg-white border-b hover:bg-gray-50">
              <td class="px-6 py-4 font-bold text-gray-900">
                <a href="/nhanvien/bookings/${booking.maDatCho}" 
                   class="text-blue-600 hover:underline">#${booking.maDatCho}</a>
              </td>
              <td class="px-6 py-4">${booking.chuyenDuLich.tour.tenTour}</td>
              <td class="px-6 py-4">${new Date(booking.ngayDat).toLocaleDateString("vi-VN")}</td>
              <td class="px-6 py-4">${getStatusBadge(booking.trangThai)}</td>
            </tr>
          `;
        });
      }
    } catch (error) {
      console.error("‚ùå L·ªói t·∫£i chi ti·∫øt kh√°ch h√†ng:", error);
    }
  }

  document.addEventListener("DOMContentLoaded", loadCustomerDetails);
</script>

  </body>
</html>
