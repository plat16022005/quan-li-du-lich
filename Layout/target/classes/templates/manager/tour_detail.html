<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th√™m Chi Ti·∫øt Tour</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
    .modal.hidden { opacity: 0; visibility: hidden; }
    .modal-content { transition: transform 0.3s ease; }
    .modal.hidden .modal-content { transform: translateY(-50px); }
  </style>
</head>
<body class="bg-gray-100">

<!-- üîπ Layout Sidebar -->
<div class="flex h-screen overflow-hidden">
  <aside class="sidebar fixed inset-y-0 left-0 z-30 w-64 bg-gray-900 text-white flex-shrink-0 md:relative md:transform-none">
    <div class="flex items-center justify-center h-20 border-b border-gray-700">
      <i class="fas fa-route text-3xl text-blue-400"></i>
      <span class="ml-3 text-2xl font-bold">TravelGO</span>
    </div>
    <nav class="mt-8 px-4">
      <a href="/manager/home" class="flex items-center px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg">
        <i class="fas fa-tachometer-alt w-6 text-center"></i>
        <span class="ml-4">T·ªïng quan</span>
      </a>
      <a href="/manager/tour" class="flex items-center px-4 py-3 mt-4 bg-gray-700 text-white rounded-lg shadow-md">
        <i class="fas fa-map-marked-alt w-6 text-center"></i>
        <span class="ml-4">Qu·∫£n l√Ω Tour</span>
      </a>
    </nav>
  </aside>

  <!-- üîπ Main content -->
  <div class="flex-1 flex flex-col overflow-y-auto">

    <!-- Header -->
    <header class="flex items-center justify-between p-6 bg-white border-b border-gray-200 sticky top-0 z-20">
      <div class="flex items-center">
        <button id="menu-button" class="md:hidden mr-4 text-gray-600">
          <i class="fas fa-bars text-2xl"></i>
        </button>
        <h1 class="text-2xl font-semibold text-gray-800">Th√™m Chi Ti·∫øt Cho Tour #<span id="tour-id-label"></span></h1>
      </div>
      <button onclick="window.history.back()" class="text-gray-600 hover:text-gray-800">
        <i class="fas fa-arrow-left mr-1"></i> Quay l·∫°i
      </button>
    </header>

    <!-- Content -->
    <main class="flex-1 p-6 space-y-8">

      <!-- üìç ƒê·ªãa ƒëi·ªÉm & L·ªãch tr√¨nh -->
      <section class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-gray-800">üìç ƒê·ªãa ƒëi·ªÉm & L·ªãch tr√¨nh</h2>
          <button onclick="openModal('add-dia-diem-modal')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
            <i class="fas fa-plus mr-2"></i> Th√™m ƒë·ªãa ƒëi·ªÉm
          </button>
        </div>
		<table class="w-full text-sm text-left text-gray-600 mb-4">
		  <thead class="bg-gray-50 text-gray-700">
		    <tr>
		      <th class="px-4 py-2 w-20">Ng√†y</th>
		      <th class="px-4 py-2 w-56">ƒê·ªãa ƒëi·ªÉm</th>
		      <th class="px-4 py-2 w-64">Ho·∫°t ƒë·ªông</th>
		      <th class="px-4 py-2 w-48">Ph∆∞∆°ng ti·ªán</th>
		      <th class="px-4 py-2 w-48">Kh√°ch s·∫°n</th>
		      <th class="px-4 py-2 text-right">H√†nh ƒë·ªông</th>
		    </tr>
		  </thead>
		  <tbody id="lich-trinh-body">
		  </tbody>
		</table>
		<button onclick="addLichTrinhRow()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
		  <i class="fas fa-plus mr-1"></i> Th√™m l·ªãch tr√¨nh
		</button>
      </section>

      <!-- üè® Kh√°ch s·∫°n -->
      <section class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-gray-800">üè® Kh√°ch s·∫°n</h2>
          <button onclick="openModal('add-hotel-modal')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
            <i class="fas fa-plus mr-2"></i> Th√™m kh√°ch s·∫°n
          </button>
        </div>
        <div id="hotel-list" class="space-y-2">
          <!-- Kh√°ch s·∫°n ƒë∆∞·ª£c ch·ªçn s·∫Ω hi·ªán ·ªü ƒë√¢y -->
        </div>
      </section>

      <!-- üöç Ph∆∞∆°ng ti·ªán -->
      <section class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-gray-800">üöç Ph∆∞∆°ng ti·ªán</h2>
          <button onclick="openModal('add-vehicle-modal')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
            <i class="fas fa-plus mr-2"></i> Th√™m ph∆∞∆°ng ti·ªán
          </button>
        </div>
        <div id="vehicle-list" class="space-y-2">
          <!-- Ph∆∞∆°ng ti·ªán ƒë∆∞·ª£c ch·ªçn s·∫Ω hi·ªán ·ªü ƒë√¢y -->
        </div>
      </section>

      <div class="flex justify-end">
        <button onclick="saveAllDetails()" class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-blue-700">
          L∆∞u chi ti·∫øt tour
        </button>
      </div>

    </main>
  </div>
</div>

<!-- ü™Ñ Modal Th√™m ƒë·ªãa ƒëi·ªÉm -->
<div id="add-dia-diem-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
  <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Th√™m ƒë·ªãa ƒëi·ªÉm m·ªõi</h3>
      <button onclick="closeModal('add-dia-diem-modal')" class="text-gray-500 text-2xl">&times;</button>
    </div>
    <label>T√™n ƒë·ªãa ƒëi·ªÉm</label>
    <input id="new-dia-diem-ten" class="w-full border rounded p-2 mb-3">
    <label>ƒê·ªãa ch·ªâ</label>
    <input id="new-dia-diem-diachi" class="w-full border rounded p-2 mb-4">
    <div class="flex justify-end">
      <button onclick="saveNewDiaDiem()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">L∆∞u</button>
    </div>
  </div>
</div>

<!-- üè® Modal Th√™m kh√°ch s·∫°n -->
<div id="add-hotel-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
  <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Th√™m kh√°ch s·∫°n m·ªõi</h3>
      <button onclick="closeModal('add-hotel-modal')" class="text-gray-500 text-2xl">&times;</button>
    </div>
    <label>T√™n kh√°ch s·∫°n</label>
    <input id="new-hotel-ten" class="w-full border rounded p-2 mb-3">
    <label>ƒê·ªãa ch·ªâ</label>
    <input id="new-hotel-diachi" class="w-full border rounded p-2 mb-3">
    <label>S·ªë ƒëi·ªán tho·∫°i</label>
    <input id="new-hotel-sdt" class="w-full border rounded p-2 mb-4">
    <label>Gi√° theo ng√†y</label>
    <input id="new-hotel-gia" class="w-full border rounded p-2 mb-4">
    <div class="flex justify-end">
      <button onclick="saveNewHotel()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">L∆∞u</button>
    </div>
  </div>
</div>

<!-- üöç Modal Th√™m ph∆∞∆°ng ti·ªán -->
<div id="add-vehicle-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
  <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Th√™m ph∆∞∆°ng ti·ªán m·ªõi</h3>
      <button onclick="closeModal('add-vehicle-modal')" class="text-gray-500 text-2xl">&times;</button>
    </div>
    <label>Lo·∫°i ph∆∞∆°ng ti·ªán</label>
    <input id="new-vehicle-loai" class="w-full border rounded p-2 mb-3">
    <label>Bi·ªÉn s·ªë</label>
    <input id="new-vehicle-biens" class="w-full border rounded p-2 mb-3">
    <label>S·ªë ch·ªó ng·ªìi</label>
    <input id="new-vehicle-socho" class="w-full border rounded p-2 mb-4" type="number">
    <label>Gi√° theo ng√†y</label>
    <input id="new-vehicle-gia" class="w-full border rounded p-2 mb-4" type="number">
    <div class="flex justify-end">
      <button onclick="saveNewVehicle()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">L∆∞u</button>
    </div>
  </div>
</div>

<script>
  // Modal functions
  function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
  function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

  async function addLichTrinhRow() {
	  const body = document.getElementById('lich-trinh-body');

	  const vehicles = await fetch('/manager/phuongtien/all').then(res => res.json());
	  const hotels = await fetch('/manager/khachsan/all').then(res => res.json());
	  const diadiems = await fetch('/manager/diadiem/all').then(res => res.json());

	  const row = document.createElement('tr');
	  row.innerHTML = `
	    <td class="px-4 py-2"><input type="number" min="1" class="border rounded p-1 w-20"></td>
	    <td class="px-4 py-2">
	      <select class="border rounded p-1 w-full">
	        <option value="">-- Ch·ªçn ƒë·ªãa ƒëi·ªÉm --</option>
	        ${diadiems.map(d => `<option value="${d.maDiaDiem}">${d.tenDiaDiem}</option>`).join('')}
	      </select>
	    </td>
	    <td class="px-4 py-2"><input type="text" placeholder="M√¥ t·∫£ ho·∫°t ƒë·ªông" class="border rounded p-1 w-full"></td>
	    <td class="px-4 py-2">
	      <select class="border rounded p-1 w-full">
	        <option value="">-- Ch·ªçn ph∆∞∆°ng ti·ªán --</option>
	        ${vehicles.map(v => `<option value="${v.maPhuongTien}">${v.loaiPhuongTien} - ${v.bienSo}</option>`).join('')}
	      </select>
	    </td>
	    <td class="px-4 py-2">
	      <select class="border rounded p-1 w-full">
	        <option value="">-- Ch·ªçn kh√°ch s·∫°n --</option>
	        ${hotels.map(h => `<option value="${h.maKhachSan}">${h.tenKhachSan}</option>`).join('')}
	      </select>
	    </td>
	    <td class="px-4 py-2 text-right">
	      <button class="text-red-600 hover:text-red-800" onclick="this.closest('tr').remove()">
	        <i class="fas fa-trash"></i>
	      </button>
	    </td>
	  `;
	  body.appendChild(row);
	}

  function saveAllDetails() {
    alert('L∆∞u to√†n b·ªô chi ti·∫øt cho tour ‚Äî b·∫°n s·∫Ω k·∫øt n·ªëi API ·ªü ƒë√¢y.');
  }

  function saveNewDiaDiem() {
    // TODO: G·ªçi API l∆∞u ƒë·ªãa ƒëi·ªÉm m·ªõi
    closeModal('add-dia-diem-modal');
  }
  function saveNewHotel() {
    // TODO: G·ªçi API l∆∞u kh√°ch s·∫°n
    closeModal('add-hotel-modal');
  }
  function saveNewVehicle() {
    // TODO: G·ªçi API l∆∞u ph∆∞∆°ng ti·ªán
    closeModal('add-vehicle-modal');
  }
</script>
<script>

  // ü™Ñ Modal
  function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
  function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

  // üìå L∆∞u kh√°ch s·∫°n m·ªõi
  async function saveNewHotel() {
    const ten = document.getElementById('new-hotel-ten').value.trim();
    const diachi = document.getElementById('new-hotel-diachi').value.trim();
    const sdt = document.getElementById('new-hotel-sdt').value.trim();
    const gia = document.getElementById('new-hotel-gia').value.trim();
    if (!ten || !diachi || !sdt) {
      alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin kh√°ch s·∫°n');
      return;
    }

    const data = { tenKhachSan: ten, diaChi: diachi, soDienThoai: sdt , giaTheoNgay: gia};

    const res = await fetch('/manager/khachsan/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if (res.ok) {
      alert('‚úÖ ƒê√£ th√™m kh√°ch s·∫°n m·ªõi');
      closeModal('add-hotel-modal');
      document.getElementById('new-hotel-ten').value = '';
      document.getElementById('new-hotel-diachi').value = '';
      document.getElementById('new-hotel-sdt').value = '';
      document.getElementById('new-hotel-gia').value = ''; 
      await loadHotels(); // refresh danh s√°ch kh√°ch s·∫°n
    } else {
      alert('‚ùå Th√™m kh√°ch s·∫°n th·∫•t b·∫°i');
    }
  }

  // üöç L∆∞u ph∆∞∆°ng ti·ªán m·ªõi
  async function saveNewVehicle() {
    const loai = document.getElementById('new-vehicle-loai').value.trim();
    const biens = document.getElementById('new-vehicle-biens').value.trim();
    const socho = document.getElementById('new-vehicle-socho').value.trim();
    const gia = document.getElementById('new-vehicle-gia').value.trim();
    if (!loai || !biens || !socho) {
      alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin ph∆∞∆°ng ti·ªán');
      return;
    }

    const data = { loaiPhuongTien: loai, bienSo: biens, soChoNgoi: Number(socho), giaTheoNgay: gia};

    const res = await fetch('/manager/phuongtien/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if (res.ok) {
      alert('‚úÖ ƒê√£ th√™m ph∆∞∆°ng ti·ªán m·ªõi');
      closeModal('add-vehicle-modal');
      document.getElementById('new-vehicle-loai').value = '';
      document.getElementById('new-vehicle-biens').value = '';
      document.getElementById('new-vehicle-socho').value = '';
      document.getElementById('new-vehicle-gia').value = '';
      await loadVehicles(); // refresh danh s√°ch ph∆∞∆°ng ti·ªán
    } else {
      alert('‚ùå Th√™m ph∆∞∆°ng ti·ªán th·∫•t b·∫°i');
    }
  }

  // üè® Load danh s√°ch kh√°ch s·∫°n ƒë·ªÉ hi·ªÉn th·ªã dropdown
  async function loadHotels() {
    const hotels = await fetch('/manager/khachsan/all').then(res => res.json());
    const list = document.getElementById('hotel-list');
    list.innerHTML = hotels.map(h => `
      <div class="border p-2 rounded flex justify-between items-center">
        <div>
          <p class="font-semibold">${h.tenKhachSan}</p>
          <p class="text-sm text-gray-600">${h.diaChi} - üìû ${h.soDienThoai}</p>
        </div>
      </div>
    `).join('');
  }

  // üöç Load danh s√°ch ph∆∞∆°ng ti·ªán ƒë·ªÉ hi·ªÉn th·ªã dropdown
  async function loadVehicles() {
    const vehicles = await fetch('/manager/phuongtien/all').then(res => res.json());
    const list = document.getElementById('vehicle-list');
    list.innerHTML = vehicles.map(v => `
      <div class="border p-2 rounded flex justify-between items-center">
        <div>
          <p class="font-semibold">${v.loaiPhuongTien}</p>
          <p class="text-sm text-gray-600">Bi·ªÉn s·ªë: ${v.bienSo} ‚Äî ${v.soChoNgoi} ch·ªó</p>
        </div>
      </div>
    `).join('');
  }

  // üß≠ Kh·ªüi ch·∫°y khi load trang
  window.addEventListener('DOMContentLoaded', async () => {
    await loadHotels();
    await loadVehicles();
    // menu button safety and active link
    try {
        const menuButton = document.getElementById('menu-button');
        const sidebar = document.getElementById('sidebar');
        if (menuButton && sidebar) menuButton.addEventListener('click', () => sidebar.classList.toggle('open'));

        const links = Array.from(document.querySelectorAll('aside#sidebar a'));
        const path = window.location.pathname.replace(/\/$/, '');
        links.forEach(a=>{
            const href = (a.getAttribute('href')||'').replace(/\/$/, '');
            if (href === path) { a.classList.remove('text-gray-300'); a.classList.add('bg-gray-700','text-white'); }
        });
    } catch(e){console.warn(e)}
  });
  function saveNewDiaDiem() {
	  const ten = document.getElementById('new-dia-diem-ten').value.trim();
	  const diachi = document.getElementById('new-dia-diem-diachi').value.trim();

	  if (!ten || !diachi) {
	    alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªãa ƒëi·ªÉm');
	    return;
	  }

	  fetch('/manager/diadiem/add', {
	    method: 'POST',
	    headers: { 'Content-Type': 'application/json' },
	    body: JSON.stringify({ tenDiaDiem: ten, diaChi: diachi })
	  })
	    .then(res => {
	      if (!res.ok) throw new Error('L·ªói khi th√™m ƒë·ªãa ƒëi·ªÉm');
	      return res.json();
	    })
	    .then(data => {
	      console.log('Th√™m th√†nh c√¥ng:', data);
	      closeModal('add-dia-diem-modal');
	      
	      // ‚úÖ Refresh l·∫°i trang
	    })
	    .catch(err => {
	      console.error(err);
	      alert('‚ùå Th√™m ƒë·ªãa ƒëi·ªÉm th·∫•t b·∫°i!');
	    });
	}
  function saveLichTrinhToLocalStorage() {
	  const rows = document.querySelectorAll('#lich-trinh-body tr');
	  const lichTrinhData = [];

	  rows.forEach(row => {
	    const inputs = row.querySelectorAll('input, select');
	    const data = {
	      ngay: inputs[0].value,
	      diaDiem: inputs[1].value,
	      hoatDong: inputs[2].value,
	      phuongTien: inputs[3].value,
	      khachSan: inputs[4].value
	    };
	    lichTrinhData.push(data);
	  });

	  localStorage.setItem('lichTrinhRows', JSON.stringify(lichTrinhData));
	}
  function restoreLichTrinhFromLocalStorage() {
	  const lichTrinhData = JSON.parse(localStorage.getItem('lichTrinhRows') || '[]');
	  lichTrinhData.forEach(data => addLichTrinhRowWithData(data));
	}
  async function addLichTrinhRowWithData(data) {
	  const body = document.getElementById('lich-trinh-body');
	  const vehicles = await fetch('/manager/phuongtien/all').then(res => res.json());
	  const hotels   = await fetch('/manager/khachsan/all').then(res => res.json());
	  const diadiems = await fetch('/manager/diadiem/all').then(res => res.json());

	  const row = document.createElement('tr');
	  row.setAttribute('data-ma-lich-trinh', data.maLichTrinh || '');

	  row.innerHTML = `
	    <td class="px-4 py-2">
	      <input type="number" value="${data.ngay ?? ''}" class="border rounded p-1 w-20" ${data.maLichTrinh ? 'disabled' : ''}>
	    </td>
	    <td class="px-4 py-2">
	      <select class="border rounded p-1 w-full" ${data.maLichTrinh ? 'disabled' : ''}>
	        <option value="">-- Ch·ªçn ƒë·ªãa ƒëi·ªÉm --</option>
	        ${diadiems.map(d => `<option value="${d.maDiaDiem}" ${d.maDiaDiem == data.diaDiem ? 'selected' : ''}>${d.tenDiaDiem}</option>`).join('')}
	      </select>
	    </td>
	    <td class="px-4 py-2">
	      <input type="text" value="${data.hoatDong ?? ''}" class="border rounded p-1 w-full" ${data.maLichTrinh ? 'disabled' : ''}>
	    </td>
	    <td class="px-4 py-2">
	      <select class="border rounded p-1 w-full" ${data.maLichTrinh ? 'disabled' : ''}>
	        <option value="">-- Ch·ªçn ph∆∞∆°ng ti·ªán --</option>
	        ${vehicles.map(v => `<option value="${v.maPhuongTien}" ${v.maPhuongTien == data.phuongTien ? 'selected' : ''}>${v.loaiPhuongTien} - ${v.bienSo}</option>`).join('')}
	      </select>
	    </td>
	    <td class="px-4 py-2">
	      <select class="border rounded p-1 w-full" ${data.maLichTrinh ? 'disabled' : ''}>
	        <option value="">-- Ch·ªçn kh√°ch s·∫°n --</option>
	        ${hotels.map(h => `<option value="${h.maKhachSan}" ${h.maKhachSan == data.khachSan ? 'selected' : ''}>${h.tenKhachSan}</option>`).join('')}
	      </select>
	    </td>
	    <td class="px-4 py-2 text-right space-x-2">
	    <button class="text-blue-600 hover:text-blue-800" onclick="editRow(this)">
	      <i class="fas fa-pen"></i>
	    </button>
	    <button class="text-green-600 hover:text-green-800 hidden" onclick="saveEditRow(this)">
	      <i class="fas fa-save"></i>
	    </button>
	    <button class="text-red-600 hover:text-red-800" onclick="deleteLichTrinh(this, '${data.maLichTrinh || ''}')">
	      <i class="fas fa-trash"></i>
	    </button>
	  </td>

	  `;
	  body.appendChild(row);
	}


  async function saveAllDetails() {
	  const tourId = Number(document.getElementById('tour-id-label').textContent.trim());
	  const rows = Array.from(document.querySelectorAll('#lich-trinh-body tr'))
	    .filter(tr => !tr.getAttribute('data-ma-lich-trinh')); // ‚úÖ ch·ªâ row m·ªõi

	  if (rows.length === 0) {
	    alert('‚ö†Ô∏è Kh√¥ng c√≥ l·ªãch tr√¨nh m·ªõi n√†o ƒë·ªÉ l∆∞u!');
	    return;
	  }

	  const lichTrinhList = rows.map(row => {
	    const inputs = row.querySelectorAll('input, select');
	    return {
	      maTour: tourId,
	      thuTuNgay: Number(inputs[0].value),
	      maDiaDiem: Number(inputs[1].value),
	      hoatDong: inputs[2].value,
	      maPhuongTien: Number(inputs[3].value),
	      maKhachSan: Number(inputs[4].value)
	    };
	  });

	  try {
	    const res = await fetch('/manager/lichtrinh/add-multiple', {
	      method: 'POST',
	      headers: { 'Content-Type': 'application/json' },
	      body: JSON.stringify(lichTrinhList)
	    });
	    if (res.ok) {
	      alert('‚úÖ ƒê√£ l∆∞u chi ti·∫øt tour th√†nh c√¥ng!');
	      // Reload l·∫°i danh s√°ch t·ª´ server (kh√¥ng c·∫ßn reload trang)
	      await loadExistingLichTrinh(tourId);
	    } else {
	      console.error(await res.text());
	      alert('‚ùå L∆∞u chi ti·∫øt tour th·∫•t b·∫°i!');
	    }
	  } catch (err) {
	    console.error(err);
	    alert('‚ùå L·ªói k·∫øt n·ªëi server khi l∆∞u l·ªãch tr√¨nh');
	  }
	}
  
  window.addEventListener('DOMContentLoaded', async () => {
	  await loadHotels();
	  await loadVehicles();

	  const tourId = getTourIdFromURL();
	  document.getElementById('tour-id-label').textContent = tourId;

	  await loadExistingLichTrinh(tourId);

	  // KH√îNG d√πng localStorage n·ªØa

	  try { setupSidebar && setupSidebar(); } catch(e) { /* ignore */ }
	});

  function getTourIdFromURL() {
	  const parts = window.location.pathname.split('/');
	  return parts[parts.length - 1]; // v·ªã tr√≠ c√≥ s·ªë 5
	}

  async function loadExistingLichTrinh(tourId) {
	  document.getElementById('lich-trinh-body').innerHTML = '';
	  try {
	    const lichTrinhList = await fetch(`/manager/lichtrinh/tour/${tourId}`).then(res => res.json());
	    for (const item of lichTrinhList) {
	      await addLichTrinhRowWithData({
	        maLichTrinh: item.maLichTrinh,                   // ‚úÖ th√™m id
	        ngay: item.thuTuNgay,
	        diaDiem: item.diaDiem?.maDiaDiem ?? '',
	        hoatDong: item.hoatDong,
	        phuongTien: item.phuongTien?.maPhuongTien ?? '',
	        khachSan: item.khachSan?.maKhachSan ?? ''
	      });
	    }
	  } catch (err) {
	    console.error('‚ùå L·ªói khi t·∫£i l·ªãch tr√¨nh:', err);
	  }
	}


  function editRow(btn) {
	  const tr = btn.closest('tr');
	  const inputs = tr.querySelectorAll('input, select');
	  inputs.forEach(el => el.removeAttribute('disabled'));
	  btn.classList.add('hidden');
	  tr.querySelector('.text-green-600').classList.remove('hidden');
	}

	async function saveEditRow(btn) {
	  const tr = btn.closest('tr');
	  const id = tr.getAttribute('data-ma-lich-trinh');
	  const inputs = tr.querySelectorAll('input, select');

	  const data = {
	    thuTuNgay: Number(inputs[0].value),
	    diaDiem: { maDiaDiem: Number(inputs[1].value) },
	    hoatDong: inputs[2].value,
	    phuongTien: { maPhuongTien: Number(inputs[3].value) },
	    khachSan: inputs[4].value ? { maKhachSan: Number(inputs[4].value) } : null
	  };

	  try {
	    const res = await fetch(`/manager/lichtrinh/save/${id}`, {
	      method: 'PUT',
	      headers: { 'Content-Type': 'application/json' },
	      body: JSON.stringify(data)
	    });

	    if (res.ok) {
	      alert('‚úÖ ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!');
	      inputs.forEach(el => el.setAttribute('disabled', 'true'));
	      btn.classList.add('hidden');
	      tr.querySelector('.text-blue-600').classList.remove('hidden');
	    } else {
	      alert('‚ùå C·∫≠p nh·∫≠t th·∫•t b·∫°i!');
	    }
	  } catch (e) {
	    console.error(e);
	    alert('‚ö†Ô∏è L·ªói k·∫øt n·ªëi server khi c·∫≠p nh·∫≠t');
	  }
	}
	async function deleteLichTrinh(btn, id) {
		  const tr = btn.closest('tr');

		  // N·∫øu ch∆∞a c√≥ ID (t·ª©c ch∆∞a l∆∞u DB) ‚Üí ch·ªâ x√≥a kh·ªèi giao di·ªán
		  if (!id) {
		    tr.remove();
		    return;
		  }

		  if (!confirm('üóë B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªãch tr√¨nh n√†y?')) return;

		  try {
		    const res = await fetch(`/manager/lichtrinh/delete/${id}`, {
		      method: 'DELETE'
		    });

		    if (res.ok) {
		      alert('‚úÖ ƒê√£ x√≥a l·ªãch tr√¨nh th√†nh c√¥ng!');
		      tr.remove();
		    } else {
		      const errorText = await res.text();
		      console.error(errorText);
		      alert('‚ùå X√≥a l·ªãch tr√¨nh th·∫•t b·∫°i!');
		    }
		  } catch (err) {
		    console.error(err);
		    alert('‚ö†Ô∏è L·ªói k·∫øt n·ªëi server khi x√≥a l·ªãch tr√¨nh');
		  }
		}

</script>

</body>
</html>
